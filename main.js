!function(e){var t={};function s(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,s),i.l=!0,i.exports}s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(n,i,function(t){return e[t]}.bind(null,i));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){"use strict";s.r(t);var n=function(){var e=function(e){this.ctx=new AudioContext,this.wave=e||"sine",this.stream=this.ctx.destination};return e.prototype.start=function(e,t,s){var n=this.ctx.createOscillator();return n.type=this.wave,n.connect(this.stream),s=(s||0)+this.ctx.currentTime,n.frequency.value=e,n.start(s),t&&n.stop(s+t),n},e}(),i=class{constructor(e){var t=this;this.status="not connected",this.isStableSignalingState=!0,this.connectionError=null,this.isConnected=!1,this.isRegistered=!1,this.isRegisterPending=!1,this.isMute=!1,this.presence={status:"",note:"",alc:null},this.currentCall={isActive:!1,isRinging:!1,contact:{}},this.incomingCall={isActive:!1,isRinging:!1},this.transferInfo={isActive:!1,destinationCallInfo:null,membersCallInfo:[]},this.onHoldCalls=[],this.calls=[],this.callIndex=0,this.callStatus={none:{value:0,label:""},initializing:{value:1,label:"initializing"},connecting:{value:2,label:"calling"},ringing:{value:3,label:"ringing"},connected:{value:4,label:"connected"},onHold:{value:5,label:"on hold"}},this.stackEvents={onError:function(e){t.onError(e)},onHoldError:function(e){t.onHoldError(e)},onEndCall:function(e,s){t.endCall(e,s)},onPresenceNotify:function(e){t.onPresence(e)},onPermissionRequest:function(e){t.onPermissionRequest(e)},onSendTextConfirmation:function(e){t.onMessageConfirmation(e)},onTypingInfo:function(e){t.onTypingInfo(e)},onIncomingCommand:function(e){t.onIncomingCommand(e)},onJoinConferenceSuccess:function(e){t._processCallConnected(e)},onJoinConferenceError:function(e,s){t.endCall(e,s)},onParticipantStatus:function(e){t.onParticipantStatus(e)},onParticipantJoin:function(e){t.onParticipantJoin(e)},onParticipantKick:this._processParticipantKick.bind(this),onParticipantSpeaking:function(e){t.onParticipantSpeaking(e)},onConferenceTokenRequest:function(e){t.onConferenceTokenRequest(e)},onScreenShareStart:function(e){e.isLocal?(t.currentCall.media.screen=!0,t.currentCall.remoteMedia.screen=!1):(t.currentCall.remoteMedia.screen=!0,t.currentCall.media.screen=!1),t.onScreenShareStart(e)},onScreenShareStop:function(e){t.currentCall.media.screen=!1,t.currentCall.remoteMedia.screen=!1,t.onScreenShareStop(e)},onPermissionAnswer:function(e){e||t.rejectIncomingCall(),t.onPermissionAnswer(e)},onWebRtcReady:function(e){e.status!=t.callStatus.connecting&&(e.isRinging=!0,e.status=t.callStatus.connecting,t.onWebRtcReady(e))},onSignalingState:function(e){t.isStableSignalingState="stable"==e,t.onSignalingState(e)},onRinging:function(e){e.isRinging=!0,e.status=t.callStatus.ringing,t.onWebRtcReady(e)},onStatusPublished:function(e){t.status=null,t.onStatusPublished(e)},onCallConnected:this._processCallConnected.bind(this),onReferCompleted:this._processReferCompleted.bind(this),onIncomingMessage:this._processIncomingMessage.bind(this),onIncomingCall:this._processIncomingCall.bind(this),onIncomingHoldCall:this._processIncomingHoldCall.bind(this),onIncomingResumeCall:this._processIncomingResumeCall.bind(this),onOutgoingHoldCall:this._processOutgoingHoldCall.bind(this),onOutgoingResumeCall:this._processOutgoingResumeCall.bind(this),onMediaStreamChange:this._processMediaStreamChange.bind(this),onReferFailed:this._processReferFailed.bind(this)},screenfull.raw&&screenfull.raw.fullscreenchange&&document.addEventListener(screenfull.raw.fullscreenchange,function(){t.currentCall.isActive&&(t.currentCall.isFullscreen=screenfull.isFullscreen)}),this.stackProxy=new vsSipml("proxy",t.stackEvents,e),this.instanceId=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}(),this.initDtmfPlayer(),this.stackConference=new ConferenceStack("sb-conf",t.stackEvents),this.stackChat=new ChatStack("sb-chat",t.stackEvents),this._lastMessageDate=new Date,this._lastMessageTo="",this._messagesCount=0,this._logDebug=function(t){e&&console.log("[vsPhone] "+t)},this.register=function(e){this.config=e;var s={realm:e.sipmlRealm,impi:e.login,impu:"sip:"+e.login+"@"+e.sipmlSipServerAddress,password:e.password,enable_click2call:e.c2c,display_name:unescape(encodeURIComponent(e.displayName)).replace(/ /g,"_"),sip_instance:e.sipInstance,websocket_proxy_url:e.sipmlWebsocketProxyUrl,outbound_proxy_url:"tcp://"+e.sipmlSipServerAddress+":"+e.sipmlSipServerPort+"/",ice_servers:e.sipmlIceServers,enable_rtcweb_breaker:!1,enable_early_ims:!1,enable_media_stream_cache:!1,bandwidth:null,video_size:null,debugLevel:e.sipmlDebugLevel,sip_headers:[{name:"User-Agent",value:"IM-client/OMA1.0 sipML5-v1.2014.12.11"},{name:"Organization",value:"Doubango Telecom"}]};this.stackProxy.initStack(s),t.isRegisterPending=!0,this.stackProxy.stackEvents.onStarting=function(e){t.isRegisterPending=!0,t.onStatusPublished()},this.stackProxy.stackEvents.onStarted=function(e){e==t.stackProxy&&(t.isConnected=!0,setTimeout(function(){t.stackProxy.register(function(e){e||(t.connectionError="SIP register failed. You will not be able to make calls"),t.isRegisterPending=!1,t.isRegistered=e,t.status=null,t.onRegistered()})},200))},this.stackProxy.stackEvents.onStopped=function(){t.isConnected=!1,t.isRegistered=!1,t.isRegisterPending=!1,t.status="not connected",t.onStatusPublished()}},this.initConferenceStack=function(e){this.stackConference.init(e),this.stackChat.init(e,this.stackConference.getSocket())},this.unregister=function(){this.isRegistered=!1,this.stackProxy.unregister()},this.removeRoomMember=function(e){this.currentCall.isActive&&this.currentCall.contact.isRoom&&this.stackProxy.removeRoomMember(this.currentCall,e)},this.logoutOtherInstances=function(){this.sendCommand(this.config.login,"logoutOtherInstances",{instanceId:this.instanceId})},this.sendCommand=function(e,t,s){var n={command:t,data:s};this.stackProxy.sendInfo(e,JSON.stringify(n),"text/plain")},this.onIncomingCommand=function(e){switch(e.command){case"logoutOtherInstances":this.instanceId!=e.data.instanceId&&this.onLogoutCommand()}},this.subscribeConference=function(e,t){this.stackConference.subscribe(e,t)},this.subscribeChat=function(e,t){this.stackChat&&this.stackChat.subscribe(e,t)}}addCall(e){e.id=this.callIndex++,e.status=this.callStatus.initializing,this.calls.push(e)}removeCallFromList(e){for(var t in this.onHoldCalls)this.onHoldCalls[t]==e&&(e.isHold=!1,this.onHoldCalls.splice(t,1));for(var t in this.calls)this.calls[t]==e&&this.calls.splice(t,1)}makeCall(e){if(this.currentCall.isActive&&!this.currentCall.isHold){var t=this;return this.currentCall.onHoldCallback=function(){t.makeCall(e)},void this.holdCall()}return e.startTime=new Date,e.status=this.callStatus.initializing,e.isCaller=!0,e.isConnected=!1,e.remoteMedia={},e.contact.isRoom?this.stackConference.join(e):this.stackProxy.makeCall(e),this.currentCall=e,e}endCall(e,t){!e&&this.currentCall.isActive&&(e=this.currentCall),e&&(e.isHold||(e.isFullscreen&&(this.toggleFullscreen(),e.isFullscreen=!1),e.isFloating&&(this.toggleFloatingBox(),e.isFloating=!1)),e.media.screen&&this.stackChat.shareScreenStop(e),e.endInfo||(e.endInfo={reason:t},e.isCaller||e.isConnected||(e.endInfo.reason="CANCEL"),t||(e.contact.isRoom?this.stackConference.leave(e):(this.stackProxy.hangUpCall(e),e.isTransfer&&(this.onReferCompleted(e),this.transferInfo.isActive=!1))),this._closeCall(e))),this.swapCalls()}rejectIncomingCall(){this.incomingCall.isRinging&&(this.incomingCall.sipSessionCall.reject(),this._closeCall(this.incomingCall))}_closeCall(e){e.isActive=!1,e.isRinging=!1,e.isConnected=!1,e.status=this.callStatus.none,this.removeCallFromList(e),e.sipSessionCall&&tmedia_stream_stop(e.sipSessionCall.o_session.get_stream_local()),e.isTransfer||this.onCallEnd(e)}_processCallConnected(e){e.isRinging=!1,e.isConnected=!0,e.status=this.callStatus.connected,this.onCallConnected(e)}holdCall(){var e=this.currentCall;e.contact.isRoom?(this._processOutgoingHoldCall(e),this.stackConference.leave(e)):e.sipSessionCall&&(e.isConnected=!1,e.status=this.callStatus.ringing,this.stackProxy.holdCall(e))}_processOutgoingHoldCall(e){if(e.status=this.callStatus.onHold,e.isConnected=!0,e.isHold=!0,this.onHoldCalls.push(e),e.contact.isRoom||this.onHoldStateChanged(e),e.onHoldCallback&&(e.onHoldCallback(),e.onHoldCallback=null),this.transferInfo.isActive)for(var t in this.transferInfo.membersCallInfo){var s=this.transferInfo.membersCallInfo[t];s.isHold&&!s.isTransferred&&(console.log("REFER to: "+this.transferInfo.destinationCallInfo.username),this.stackProxy.transferCall(s,this.transferInfo.destinationCallInfo.username),s.isTransferred=!0)}}_processOutgoingResumeCall(e){var t=this.onHoldCalls.indexOf(e);t>-1&&(e.status=this.callStatus.connected,e.isConnected=!0,e.isHold=!1,this.onHoldCalls.splice(t,1),this.currentCall=e,e.contact.isRoom||this.onHoldStateChanged(e))}_processIncomingHoldCall(e){e.status=this.callStatus.onHold,e.isHold=!0,e.isIncomingHold=!0,this.onHoldStateChanged(e)}_processIncomingResumeCall(e){e.status=this.callStatus.connected,e.isConnected=!0,e.isHold=!1,e.isIncomingHold=!1,this.onHoldStateChanged(e)}resumeCall(e){this.onHoldCalls.indexOf(e)>-1&&(e.contact.isRoom?(this._processOutgoingResumeCall(e),e.isSingleJoin=!0,this.stackConference.join(e)):(e.isConnected=!1,e.status=this.callStatus.ringing,this.stackProxy.resumeCall(e)))}transferCall(e){console.log("transferCall to: "+e),this.currentCall.contact.isRoom||this.stackProxy.transferCall(this.currentCall,e)}_processReferCompleted(e){if(this.transferInfo.isActive){var t=this.onHoldCalls.indexOf(e);for(var t in t>-1&&(e.isHold=!1,this.onHoldCalls.splice(t,1)),this.transferInfo.membersCallInfo)if(!this.transferInfo.membersCallInfo[t].isTransferred)return;if(this.transferInfo.isActive=!1,this.onReferCompleted(this.currentCall),this.transferInfo.isJoin)this.resumeCall(this.transferInfo.destinationCallInfo);else if(this.currentCall.isActive&&(this.stackProxy.hangUpCall(this.currentCall),this._closeCall(this.currentCall)),!this.transferInfo.destinationCallInfo.isSingleTransfer){console.log("join to transfer destination when all members were transferred");var s=this;setTimeout(function(){s.makeCall(s.transferInfo.destinationCallInfo),console.log("transfer completed, make call to "+s.transferInfo.destinationCallInfo.username)},200)}}}_processReferFailed(e){this.transferInfo.isActive=!1,this.swapCalls()}_processIncomingCall(e){if(this.incomingCall.isRinging)return e.sipSessionCall.reject(),void console.log("call rejected only 1 incoming call is supported");e.startTime=new Date,e.isCaller=!1,e.isActive=!1,e.isRinging=!0,e.isConnected=!1,this.incomingCall=e,this.onIncomingCall(e)}pickupCall(e){return this.currentCall.isActive&&this.holdCall(),e.status=this.callStatus.initializing,e.isActive=!0,this.stackProxy.pickupCall(e),e.remoteMedia.video&&!e.media.video&&this.stackProxy.sendInfo(e.username,JSON.stringify({isMediaStreamTrackEnable:!1,"Content-Type":"video/stream"}),"text/plain"),this.currentCall=e,e}makeConference(e){if(this.transferInfo.isActive)console.log("Transfer is going on!");else if(this.transferInfo.destinationCallInfo=e,this.transferInfo.membersCallInfo=[],this.transferInfo.isJoin=!1,this.currentCall.isActive){var t=this.onHoldCalls.slice(0);for(var s in t.push(this.currentCall),t){var n=t[s];n.isTransferred=!1,n.isAutoJoin?this.removeCallFromList(n):n.contact.isRoom?(this.transferInfo.isJoin=!0,this.transferInfo.destinationCallInfo=n):(n.isTransfer=!0,this.transferInfo.membersCallInfo.push(n))}if(console.log(this.transferInfo),this.transferInfo.membersCallInfo.length>0)if(this.transferInfo.isActive=!0,this.currentCall.isAutoJoin)for(var s in this.transferInfo.membersCallInfo){var i=this.transferInfo.membersCallInfo[s];i.isHold&&!i.isTransferred&&(console.log("REFER to: "+this.transferInfo.destinationCallInfo.username),this.stackProxy.transferCall(i,this.transferInfo.destinationCallInfo.username),i.isTransferred=!0)}else this.holdCall();else{console.log("no conference members to transfer");var o=this;setTimeout(function(){o.endCall(),e.isJoin=!0,o.onReferCompleted(e)},2e3)}}}swapCalls(e){this.onHoldCalls.length>0&&(!this.currentCall.isHold&&this.currentCall.isConnected&&this.holdCall(),e?this.resumeCall(e):this.resumeCall(this.onHoldCalls[0]))}addToCall(e){var t=this.currentCall;t.isActive&&t.contact.isRoom&&this.stackConference.addToCall(t,e)}_processParticipantKick(e){if(e.isLocal)for(var t in this.calls){var s=this.calls[t];if(s.contact&&s.contact.id==e.groupId){for(var n in s.contact.participants)s.contact.participants[n].onDisconnected();return void this.endCall(s,"You have been removed")}}}sendChat(e,t,s,n,i){if(""==t||null==t||null==t)return!1;if((new Date-this._lastMessageDate)/1e3<1&&"~[READ:"!=t.substr(0,7)&&this._lastMessageTo!=e?this._messagesCount++:this._messagesCount=0,this._messagesCount>=3)return console.warn("chat messages limit exceeded"),!1;try{if(useSocketBridgeForOnNetChat&&(t.startsWith("~[CONF:")||t.startsWith("~[READ:")))return this.stackChat.sendText(e,t),!0;this.stackProxy.sendText({to:e,content:t,id:s,callerId:n,use_caller_id_as_from_user_name:!i}),this._lastMessageDate=new Date,this._lastMessageTo=e}catch(e){return this._logDebug(e),!1}return!0}sendText(e,t,s,n,i){if(""==t||null==t||null==t)return null;var o=this._generateMessageId();return s&&(t="~[ID:"+o+"]"+(JSON.stringify(i)||"")+t),this.sendChat(e,t,o,n,s)?o:null}sendTextSb(e,t,s){return new Promise((n,i)=>{var o=this._generateMessageId();t="~[ID:"+o+"]"+(JSON.stringify(s)||"")+t,this.stackChat.sendText(e,t).then(e=>{n(o,e)}).catch(e=>{i(e)})})}sendFile(e,t,s){var n="~[ATT RID:'"+t.rid+"' type:'"+t.type+"' ext:'"+t.ext+"' or:'0']"+(JSON.stringify(t.info)||"");return s?s(n):this.sendText(e,n,!0)}sendVcard(e,t,s){var n="~[ATT RID:'0' type:'5' ext:'.vcf']"+vsDocumentVcard().serialize(t);return s?s(n):this.sendText(e,n,!0)}sendLocation(e,t,s){var n=[];for(var i in t.markers)if(!isNaN(parseFloat(i))&&isFinite(i)){var o=t.markers[i];n.push({la:o.coords.latitude,lo:o.coords.longitude,d:o.text})}n.push({z:t.zoom});var r=JSON.stringify(n),a="~[LOC J:'"+Base64.encode(r)+"']";return s?s(a):{messageBody:a,id:this.sendText(e,a,!0)}}parseReadConfirmationMessage(e){return(result=/~\[READ:(.+?)\]/gi.exec(e))?{id:result[1]}:null}parseMessage(e){var t={};if(a=this.parseAttachmentMessage(e))t.type="attachment",t.attachment=a;else if(r=this.parseReadConfirmationMessage(e))t.type="read",t.read=r;else if(lm=this.parseLocationMessage(e))t.type="location",t.location=lm;else{if(t.type="text",e&&0===e.indexOf("{")){var s=this._extractMessageDescription(e);s&&s.indexes&&0===s.indexes[0]&&(e=e.substring(s.indexes[1]),t.info=s.obj)}t.textBody=e}return t}_extractMessageDescription(e){var t=e.indexOf("{"),s=0,n="";do{if((s=e.lastIndexOf("}"))<=t)return null;do{n=e.substring(t,s+1);try{var i=JSON.parse(n),o=["REPLY_TO","VMAIL_TRANSCRIPTION","filename","contentType","size","du","da"],r=!1;for(var a in i)if(o.indexOf(a)>=0){r=!0;break}return r?{obj:i,json:n,indexes:[t,s+1]}:null}catch(e){}s=e.substr(0,s).lastIndexOf("}")}while(s>t);t=e.indexOf("{",t+1)}while(-1!=t);return null}parseLocationMessage(e){if(result=/~\[LOC J:\'(.+?)\'\]/gi.exec(e)){var t=JSON.parse(Base64.decode(result[1])),s={markers:[]};for(var n in t)if(null!=t[n].z)s.zoom=parseInt(t[n].z);else{var i={id:n,coords:{latitude:t[n].la,longitude:t[n].lo,name:t[n].n,url:t[n].u,address:t[n].a},text:t[n].d};s.markers.push(i)}return s.center={latitude:t[0].la,longitude:t[0].lo},s}return null}_generateMessageId(){var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";e+=t.charAt(Math.floor(50*Math.random()));for(var s=0;s<5;s++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}parseAttachmentMessage(e){var t=function(t,s){var n=new RegExp(t+":'([0-9]+)'","gi");s||(n=new RegExp(t+":'([\\w\\s\\.]+)'","gi"));var i=n.exec(e);return i?s?parseInt(i[1]):i[1]:""};if(e&&!("string"==typeof e||e instanceof String)&&console.log("Text not a string"),null!=e&&null!=e&&("string"==typeof e||e instanceof String)&&"~[ATT "==e.substr(0,6).toUpperCase()){var s={};if(s.rid=t("rid",!0),s.type=t("type",!0),s.ext=t("ext",!1),s.caption=t("caption",!1),s.orientation=t("or",!0),s.info=function(){var t=/~\[.+\]({.+})*.*/gi.exec(e);return t&&2===t.length&&t[1]?JSON.parse(t[1]):{}}(),5==s.type){var n=e.substring(e.indexOf("BEGIN:VCARD"));s.vCard=vsDocumentVcard().parse(n)}return s}return null}parseGroupChatMessage(e){var t={type:"MG",text:e,rawText:e};if(result=/~\[GC M:\'(.+)\' GID:([0-9]+) MID:([0-9]+)(\W*MB:\[?\'(.+)\'\]?)?\](.*)?/gi.exec(e)){if(t.type=result[1],t.groupId=result[2],t.messageId=result[3],t.memberId=result[5],result[6]&&("NG"==t.type||"EG"==t.type))try{var s=JSON.parse(result[6]);s&&"object"==typeof s&&(t.js=s)}catch(e){}switch(t.type){case"MG":t.text=result[6];break;case"NG":t.text="Group has been created ";break;case"DG":t.text="Group has been removed ";break;case"EG":t.text="Group has been edited ";break;case"JG":t.text="Member has joined group ";break;case"LG":t.text="Member has left group ";break;case"DM":t.text="Member has been removed ";break;case"NM":t.text="Member has been added "}}else 0==e.indexOf("~[")&&0!=e.indexOf("~[ATT")&&0!=e.indexOf("~[LOC")&&(console.log("bad message format",e),t.type="error");return t}sendReadConfirmation(e,t){this.sendChat(e,"~[READ:"+t+"]","")}_processIncomingMessage(e){var t=e.message;if(t.startsWith("SIPLINK_COMMAND : ")){var s=/^SIPLINK_COMMAND : (.+?) : (.+)/gim.exec(t);if(s&&3===s.length)return void this.onIncomingCommand({username:e.username,type:s[1],command:JSON.parse(s[2]),rawMessage:t})}for(var n=/~\[(.*?):(.+?)\]([.\s\S]*)/gim;result=n.exec(t);){var i=result[1],o=result[2];switch(t=result[3],n.exec(t),i){case"ID":try{e.messageId=o,this.sendChat(e.username,"~[CONF:"+o+"]","")}catch(e){console.warn(e)}if(a=this.parseAttachmentMessage(t))return void this.onIncomingFile({username:e.username,attachment:a,messageId:o,rawMessage:t});if(lm=this.parseLocationMessage(t))return void this.onIncomingLocation({username:e.username,location:lm,messageId:o,rawMessage:t});if(t&&0===t.indexOf("{")){var r=this._extractMessageDescription(t);r&&r.indexes&&0===r.indexes[0]&&(t=t.substring(r.indexes[1]))}break;case"CONF":this.onMessageConfirmation({username:e.username,messageId:o,status:"delivered"});break;case"READ":this.onMessageConfirmation({username:e.username,messageId:o,status:"read"});break;case"GC M":if(gcm=this.parseGroupChatMessage(e.message)){e.groupMessageType=gcm.type,e.groupId=gcm.groupId,e.messageId=gcm.messageId;var l=e.username;switch(-1==l.indexOf(":")&&(l=gcm.groupId+":"+e.username),gcm.type){case"NG":return void this.onGroupChatNotification({type:"NG",username:e.username,groupId:gcm.groupId,message:e.message});case"MG":if(a=this.parseAttachmentMessage(gcm.text))return void this.onIncomingFile({username:e.username,groupId:gcm.groupId,attachment:a,messageId:gcm.messageId,groupMessageType:e.groupMessageType,rawMessage:t});if(lm=this.parseLocationMessage(gcm.text))return void this.onIncomingLocation({username:e.username,groupId:gcm.groupId,location:lm,messageId:gcm.messageId,groupMessageType:e.groupMessageType,rawMessage:t});break;case"JG":case"LG":e.memberId=gcm.memberId,this.onGroupChatMembersEvent({type:gcm.type,memberId:gcm.memberId,groupId:gcm.groupId});break;case"EG":break;case"DG":this.onGroupChatMembersEvent({type:gcm.type,memberId:gcm.memberId,groupId:gcm.groupId});case"NM":case"DM":return void this.onGroupChatNotification({type:gcm.type,username:e.username,groupId:gcm.groupId,message:e.message});case"CM":case"RM":var c="CM"==gcm.type?"delivered":"read";this.onMessageConfirmation({username:""+gcm.groupId,messageId:gcm.messageId,status:c,isRoom:!0,groupId:gcm.groupId})}}}}""!=t&&(e.message=t,this.onIncomingChat(e))}handleTypingInfo(e,t){var s,n=this,i=!1,o=e,r={start:function(e,s){t.username?n.sendTypingInfo(t.username,!0):t.usernames&&t.groupId&&n.sendTypingInfoToGroup(t.usernames,t.groupId,!0)},stop:function(e,s){t.username?n.sendTypingInfo(t.username,!1):t.usernames&&t.groupId&&n.sendTypingInfoToGroup(t.usernames,t.groupId,!1)},delay:1500};function a(e){i||(i=!0,r.start&&r.start(e,o))}function l(e,t){i&&(clearTimeout(s),s=setTimeout(function(){i=!1,r.stop&&r.stop(e,o)},t>=0?t:r.delay))}o.off("keypress"),o.off("keydown"),o.keypress(a),o.keydown(function(e){8!==e.keyCode&&46!==e.keyCode||a(e)}),o.keyup(l),o.blur(function(e){l(e,0)})}sendTypingInfo(e,t){var s=t?"start":"stop",n=vsDocumentTypingInfo().serialize(s);this.stackProxy.sendInfo(e,n+"\r\n","text/plain")}sendTypingInfoToGroup(e,t,s){var n=s?"start":"stop",i=vsDocumentTypingInfo().serialize(n,t);for(var o in e)this.stackProxy.sendInfo(e[o],i+"\r\n","text/plain")}getUnsentMessages(){var e=[],t=/~\[ID:[\w]*\](.*)/gi;for(var s in this.stackProxy._messageBuffer){var n=JSON.parse(JSON.stringify(this.stackProxy._messageBuffer[s]));(result=t.exec(n.content))&&(n.content=result[0]),e.push(n)}return e}sendDtmf(e){this.currentCall&&this.currentCall.sipSessionCall&&this.currentCall.isActive&&this.currentCall.sipSessionCall.dtmf(e)}playDtmf(e){var t=this.dtmfLut[e].row,s=this.dtmfLut[e].col;this.tone.start(this.dtmfRows[t],.1,void 0),this.tone.start(this.dtmfCols[s],.1,void 0)}initDtmfPlayer(){var e=[["1","2","3","A"],["4","5","6","B"],["7","8","9","C"],["*","0","#","D"]];this.dtmfLut={};for(var t=0;t<e.length;++t)for(var s=0;s<e[t].length;++s)this.dtmfLut[e[t][s]]={row:t,col:s};var i=function(e,t){for(var s=[e=Math.round(e)],n=0;n<t.length;++n)s[n+1]=s[n]+t[n];return s};this.dtmfRows=i(697,[73,82,89]),this.dtmfCols=i(1209,[127,141,156]),this.tone=new n}onIncomingCall(){console.log("vsPhone.onIncomingCall")}onIncomingChat(){console.log("vsPhone.onIncomingChat")}onGroupChatNotification(){console.log("vsPhone.onGroupChatNotification")}onGroupChatMembersEvent(){console.log("vsPhone.onGroupChatMembersEvent")}onIncomingFile(){console.log("vsPhone.onIncomingFile")}onIncomingLocation(){console.log("vsPhone.onIncomingLocation")}onIncomingCommand(){console.log("vsPhone.onIncomingCommand")}onMessageConfirmation(){console.log("vsPhone.onMessageConfirmation")}onPresence(){console.log("vsPhone.onPresence")}onStatusPublished(){console.log("vsPhone.onStatusPublished")}onPresencePermission(){console.log("vsPhone.onPresencePermission")}onCallEnd(){console.log("vsPhone.onCallEnd")}onCallConnected(){console.log("vsPhone.onCallConnected")}onHoldStateChanged(){console.log("vsPhone.onHoldStateChanged")}onHoldError(){console.log("vsPhone.onHoldError")}onReferCompleted(){console.log("vsPhone.onReferCompleted")}onReferFailed(){console.log("vsPhone.onReferFailed")}onWebRtcReady(){console.log("vsPhone.onWebRtcReady")}onSignalingState(){console.log("vsPhone.onSignalingState")}onPermissionRequest(){console.log("vsPhone.onPermissionRequest")}onPermissionAnswer(e){console.log("vsPhone.onPermissionAnswer, isAccepted = "+e)}onConnectionError(){console.log("vsPhone.onConnectionError")}onError(){console.log("vsPhone.onError")}onRegistered(){console.log("vsPhone.onRegistered")}onTypingInfo(){console.log("vsPhone.onTypingInfo")}onLogoutCommand(){console.log("vsPhone.onLogoutCommand")}onParticipantStatus(){console.log("vsPhone.onParticipantStatus")}onParticipantJoin(){console.log("vsPhone.onParticipantJoin")}onParticipantKick(){console.log("vsPhone.onParticipantKick")}onScreenShareStart(){console.log("vsPhone.onScreenShareStart")}onScreenShareStop(){console.log("vsPhone.onScreenShareStop")}onParticipantSpeaking(){console.log("vsPhone.onParticipantSpeaking")}onConferenceTokenRequest(){console.log("vsPhone.onConferenceTokenRequest")}toggleAudio(){if(this.currentCall.isActive){var e=this.currentCall.media.audio;this.currentCall.media.audio=!e,this.currentCall.contact.isRoom?this.stackConference.changeMedia(this.currentCall,this.currentCall.media):this.stackProxy.muteAudio(this.currentCall,e)}}toggleVideo(){if(this.currentCall.isActive){var e=this.currentCall.media.video;if(this.currentCall.media.video=!e,this.currentCall.contact.isRoom)this.stackConference.changeMedia(this.currentCall,this.currentCall.media);else{var t={isMediaStreamTrackEnable:!e,"Content-Type":"video/stream"};this.stackProxy.sendInfo(this.currentCall.username,JSON.stringify(t),"text/plain"),this.stackProxy.muteVideo(this.currentCall,e),this.currentCall.media.video&&(this.currentCall.sipSessionCall.o_session.b_stream_local_changed=!0)}}}toggleMute(){this.currentCall.isActive&&(this.isMute=!this.isMute,this.currentCall.media.video=!this.isMute,this.stackProxy.muteVideo(this.currentCall,this.isMute),this.currentCall.media.audio=!this.isMute,this.stackProxy.muteAudio(this.currentCall,this.isMute))}toggleFullscreen(){if(this.currentCall.isActive){this.currentCall.isFloating&&this.toggleFloatingBox();var e=this.currentCall.previewElement;screenfull.toggle(e),this.currentCall.isFullscreen=screenfull.isFullscreen}}toggleFloatingBox(e){if(this.currentCall){this.currentCall.isFullscreen&&this.toggleFullscreen();var t=$(this.currentCall.previewElement);if(this.currentCall.isFloating=!this.currentCall.isFloating,this.currentCall.isFloating){var s={top:"0",left:"50%",width:"640",height:"480"};e&&(s=e);try{var n=localStorage.getItem("vs-vuc-conf-box");n&&(s=JSON.parse(n))}catch(e){}t.draggable("instance")&&t.draggable("enable").resizable("enable"),t.css("width",s.width).css("height",s.height).css("top",s.top).css("left",s.left).draggable().resizable({containment:"body",minHeight:240,minWidth:400,aspectRatio:!1,resize:function(e,t){t.size.height>t.size.width&&(t.size.height=t.size.width)}})}else s={top:t.css("top"),left:t.css("left"),width:t.css("width"),height:t.css("height")},localStorage.setItem("vs-vuc-conf-box",JSON.stringify(s)),t.draggable("disable").resizable("disable").css("top","0").css("left","0").css("width","100%").css("height","100%")}}_processMediaStreamChange(e){console.log(e),"video/stream"!=e["Content-Type"]||(this.currentCall.remoteMedia.video=e.isMediaStreamTrackEnable,this.currentCall.sipSessionCall.o_session.b_stream_remote_changed=!0,this.currentCall.sipSessionCall.o_session.b_stream_local_changed||!this.currentCall.remoteMedia.video||this.currentCall.media.video)||this.stackProxy.sendInfo(this.currentCall.username,JSON.stringify({isMediaStreamTrackEnable:!1,"Content-Type":"video/stream"}),"text/plain")}shareScreen(e){e.contact.isRoom?this.stackConference.shareScreen(e):(this.currentCall.sbId=e.sbId,this.stackChat.shareScreen(this.currentCall))}checkScreenShareExtensionStatus(e){return new Promise((t,s)=>{if(this.isScreenShareExtensionChecking)s("checking extension in progress");else{this.isScreenShareExtensionChecking=!0;let n=this.config.screenShareChromeExtensionId;try{getChromeExtensionStatus(s=>{this.isScreenShareExtensionChecking=!1,console.log("getChromeExtensionStatus",s);var i={status:"installed-enabled"==s,url:"https://chrome.google.com/webstore/detail/screen-capturing/"+n};e&&!i.status&&confirm(`Screen share extension is not installed or disabled. Click OK to open Chrome Web Store or follow this link ${url}. Install the extension or enable it.`)&&window.open(i.url),t(i)})}catch(e){s("checking extension in progress")}}})}setPresence(e,t,s){this.connectionError=null,this.status="publishing status...",null!=e&&(this.presence.status=e),null!=t&&(this.presence.note=t),null!=s&&(this.presence.alc=s);var n="sip:"+this.config.login+"@"+this.config.sipmlSipServerAddress;this.stackProxy.publish(this.presence,n)}subscribePresence(e){this.stackProxy.subscribe(e)}unsubscribePresence(e){this.stackProxy.unsubscribe()}};s.d(t,"FontumiClient",function(){return o});class o extends i{constructor({login:e,password:t,debug:s=!1}){if(!e)throw new Error("Wrong params. Missing login");if(!t)throw new Error("Wrong params. Missing password.");super(s);const n={login:e,password:t,offNetPrefix:"int",onNetPrefix:"",sipmlDebugLevel:"info",sipmlIceServers:"",sipmlSipServerAddress:"173.237.184.239",sipmlSipServerPort:"5060",sipmlWebsocketProxyUrl:"wss://artnetbreaker.hstsrv.net:10062/",sipmlTpHttpServerUrl:"",sipmlTpIceServers:"",sipmlTpRealm:"",sipmlTpWebsocketProxyUrl:"ws://artnetbreaker.hstsrv.net:20060/",sipmlRealm:"VoipSwitch",conferenceServerUrl:"",conferenceToken:null};this.register(n)}}"undefined"!=typeof window&&(window.FontumiClient=o)}]);